@page "/subscriptions"
@using Admin.Services
@using Admin.Dto_s
@inject Admin.Services.AdminService AdminService

<h3>Client Subscriptions</h3>

<!-- Subscription Counts -->
<div class="row">
    <div class="col-md-4">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Total Subscriptions</h5>
                <p class="card-text">@totalSubscriptions</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Active Subscriptions</h5>
                <p class="card-text">@activeSubscriptions</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Expired Subscriptions</h5>
                <p class="card-text">@expiredSubscriptions</p>
            </div>
        </div>
    </div>
</div>

<!-- Subscription List Table -->
@if (clientSubscriptions == null)
{
    <p>Loading...</p>
}
else
{
    <table class="table mt-3">
        <thead>
            <tr>
                <th>Subscription ID</th>
                <th>Client Name</th>
                <th>Subscription Plan Name</th>
                <th>Description</th>
                <th>Price</th>
                <th>Start Date</th>
                <th>End Date</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var subscription in clientSubscriptions)
            {
                <tr>
                    <td>@subscription.ClientSubscriptionId</td>
                    <td>@subscription.ClientName</td>
                    <td>@subscription.SubscriptionPlanName</td>
                    <td>@subscription.SubscriptionPlanDescription</td>
                    <td>@subscription.Price</td>
                    <td>@subscription.StartDate.ToShortDateString()</td>
                    <td>@subscription.EndDate.ToShortDateString()</td>
                    <td>@subscription.Status</td>
                    <td>
                        <button class="btn btn-danger" @onclick="() => DeleteClientSubscription(subscription.ClientSubscriptionId)">Delete</button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

<!-- Add Subscription Button (if needed in the future) -->
<!-- <button class="btn btn-primary mt-3" @onclick="ShowCreateSubscriptionModal">Add Subscription</button> -->
@code {
    private List<ClientSubscriptionBlazorDto> clientSubscriptions;
    private int totalSubscriptions;
    private int activeSubscriptions;
    private int expiredSubscriptions;

    protected override async Task OnInitializedAsync()
    {
        await LoadSubscriptions();
    }

    private async Task LoadSubscriptions()
    {
        // Fetch all client subscriptions from the service
        clientSubscriptions = await AdminService.GetAllClientSubscriptionsAsync();

        // Calculate subscription stats
        totalSubscriptions = clientSubscriptions.Count;
        activeSubscriptions = clientSubscriptions.Count(s => s.Status == "Active");
        expiredSubscriptions = clientSubscriptions.Count(s => s.Status == "Expired");
    }

    private async Task DeleteClientSubscription(int id)
    {
        // Remove client subscription
        await AdminService.RemoveClientSubscriptionAsync(id);
        await LoadSubscriptions(); // Refresh the list after deletion
    }
}
